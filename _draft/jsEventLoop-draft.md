---
layout: post
title: "[JS] 자바스크립트의 동작 원리"
date: 2019-10-27 12:00:00
category:
- javascript
- nodejs
tag:
- javascript
- event loop
- nodejs
comments: true
---

자바스크립트는 '단일 스레드' 기반의 언어다. 이 말은 동시에 하나의 작업만을 처리할 수 있다는 말이다.  
하지만 실제로 자바스크립트를 사용하는 환경을 보면 동시성(Concurrency)을 가지고 있고 성능 또한 우수하다.  
예를 들어 월마트가 노드JS 서버로 블랙프라이데이 온라인 트래픽의 53%를 처리할 때 노드 서버의 CPU 이용도가 약 1%였다는 것, 페이팔이 자바에서 노드JS로 교체 후 평균 응답시간이 35%가 단축된 것과 같은 사례들이 우수한 성능을 보여주고 있다는 증거다.  
어떻게 단일 스레드 기반의 언어가 이런 성능을 낼 수 있었는지 동작 원리를 정리하게 되었다.


## 자바스크립트 런타임(Runtime)
자바스크립트 엔진은 메모리 힙(Heap)과 단일 호출 스택(Call Stack)을 가지고 있다. 그리고 이 자바스크립트 엔진을 구동하는 환경(Node.js, 브라우저)이 큐(Queue)와 이벤트 루프(Event Loop)를 통해 비동기와 동시성을 담당한다.

엔진과 구동 환경을 통해 힙, 스택, 큐, 이벤트 루프를 언급한 것으로 예측할 수 있지만, ECMAScript 자체에는 단일 호출 스택, 큐, 이벤트 루프 등에 대한 명세는 없다. 자바스크립트 동작의 핵심은 자바스크립트 엔진이 단일 호출 스택을 이용해서 실행하고, 엔진이 실행되는 환경인 브라우저와 노드JS와 같은 곳에서 큐와 이벤트 루프를 통해 비동기성과 동시성을 처리하는 것이다.

![jsRuntime](/assets/images/post/jsRuntime.png)*\<이미지 출처: [자바스크립트는 어떻게 작동하는가](https://engineering.huiseoul.com/%EC%9E%90%EB%B0%94%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%9E%91%EB%8F%99%ED%95%98%EB%8A%94%EA%B0%80-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EB%A3%A8%ED%94%84%EC%99%80-%EB%B9%84%EB%8F%99%EA%B8%B0-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%EC%9D%98-%EB%B6%80%EC%83%81-async-await%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%BD%94%EB%94%A9-%ED%8C%81-%EB%8B%A4%EC%84%AF-%EA%B0%80%EC%A7%80-df65ffb4e7e) \>*

### 힙(Heap)
객체들이 힙 안에 할당된다. 힙은 구조화되지 않은 넓은 메모리 영역을 지칭한다.

### 단일 호출 스택(Call Stack)
자바스크립트 엔진은 단일 호출 스택(Call Stack)을 가지고 있다. 하나의 호출 스택만을 가지고 있기 때문에 한 번에 단 하나의 함수만 처리할 수 있다.  
이렇게 하나의 함수가 처리될 때 다른 함수가 끼어들 수 없는 것을 *Run to completion*이라고 한다.

### 큐(Queue)
이벤트 큐, 태스크 큐라고도 불리는 자바스크립트에서 큐는 자바스크립트 엔진 자체에 존재하지 않는다. 큐는 자바스크립트 엔진을 실행하는 환경에서 존재한다.  
큐의 역할은 호출 스택이 비워지기 전까지 실행될 콜백 함수들을 대기시키는 역할을 한다.

### 이벤트 루프(Event Loop)
이벤트 루프 또한 자바스크립트 엔진을 실행하는 환경에서 존재한다. 이벤트 루프는 스택이 비워질 때마다 큐에서 콜백 함수를 꺼내와서 실행하는 역할을 한다. 이때 콜백 함수는 호출 스택에 추가된다.

### 자바스크립트의 동작
1. 자바스크립트에서 함수가 호출될 때 단일 호출 스택에 쌓인다.
2. 이때 Web API에서 사용되는 비동기 함수(대표적으로 setTimeout을 예로 들수 있다)들은 실행되고 콜백 함수를 태스크 큐에 쌓는다.
3. 이벤트 루프는 호출 스택이 비워질 때 큐에 있던 태스크를 호출 스택으로 옮긴다.
4. 이벤트 루프는 큐가 비워졌으니 다시 생길 때까지 기다린다.

간단한 코드로 이 실행순서를 시각화할 수 있다.

```js
function foo() { 
  console.log('foo()');
}

function bar() {
  console.log('bar()');
}

setTimeout(foo, 10);
bar();

/**
bar()
foo()
*/
```

위 코드를 동기적으로 동작할 것이라고 예상하고 본다면 10ms 뒤에 foo()가 출력되고, 그다음 bar()가 출력될 것이라 예상할 것이다. 하지만 setTimeout은 Web API에서 제공되는 비동기 함수이므로 콜백 함수를 큐에 쌓기 때문에 스택에 존재하는 bar() 함수가 실행되어 비워질 때까지 대기하게 된다.

이 코드의 호출 스택 순서를 시각화하면 아래와 같다. (anonymous는 익명 함수이다. 전역 환경에서 실행되는 코드는 한 단위의 코드 블록으로써 가상의 익명 함수로 감싸져 있다. 그래서 실행될 때 맨 아래 추가되고 마지막 함수가 종료될 때 제거된다.)

![CallStack](/assets/images/post/stackExample.png)*\<호출 스택 변화 순서\>*



## 자바스크립트가 단일 스레드라는 것
간단히 자바스크립트의 동작에 대해 정리해 보았다. 하지만 앞서 정리한 거로는 단일 스레드인 자바스크립트가 동시성을 어떻게 처리하는지 상상이 가지 않는다. 어떻게 노드JS에서 높은 동시성을 요구할 때 높은 성능을 낼 수 있었을까?

ECMAScript, 자바스크립트 엔진, 엔진 구동 환경을 분리해서 이해하고 접근하면 그 해답을 찾을 수 있다.

![NodeJSSystem](/assets/images/post/nodejsSystem.jpg)*\<이미지 출처: [nodejs의 내부 동작 원리](https://sjh836.tistory.com/149?category=710138) 노드JS 시스템 아키텍쳐\>*

노드JS로 예로 들면 위 이미지에서 볼 수 있듯이 노드JS는 비동기 I/O를 지원하기 위해 [libuv](https://libuv.org/) 라이브러리를 사용하며, libuv는 커널단(윈도우는 IOCP, 리눅스는 AIO)의 비동기 함수를 호출하거나, 커널에서 지원하지 않는 기능은 여러 개의 libuv의 워커 스레드를 사용하는 것을 알 수 있다.

여기서 알 수 있듯이 '자바스크립트가 단일 스레드'라는 표현은 **자바스크립트 엔진의 단일 호출 스택 환경에만 적용**이 된다. 그리고 **비동기 I/O들은 여러 개의 스레드를 사용**해서 처리한다.

또 중요한 점은 **이벤트 루프의 역할**은 단지 태스크 큐를 관리하는 게 아닌, **실제 단일 호출 스택을 사용하는 자바 스크립트 엔진과 여러 개의 스레드를 사용하고 있는 자바스크립트 구동 환경이 상호 연동하는 중요한 역할**을 하는 것을 알 수 있다.

이렇게 자바스크립트는 구동 환경에서 여러 개의 스레드를 통해 비동기 I/O 업무를 처리하기 때문에 높은 동시성을 확보할 수 있었던 것이다.


## 글을 마무리 하며
자바스크립트의 동작 원리를 로우 레벨로 조사하기 이전보다 자바스크립트 코드가 어떻게 동작하는지 더 명확해졌다. 단일 스레드 기반의 언어'라는 의구심을 시작으로 조사해보면서 어떻게 많은 동시성을 가진 I/O 업무를 처리할 수 있었는지 명확하게 이해할 수 있었다.

그리고 다시 한번 자바스크립트는 다른 언어와 다른 부분이 많고 로우레벨로 갈수록 학습곡선의 경사가 높다는 것을 또 한 번 느꼈다. 그래서 더 매력적인 언어로 느껴지고 코드 작성 시 즐거움이 배로 되는 것 같다.

요즘 네이티브 라이브러리 프로젝트를 진행해보려고 고랭(Go)에 관심이 가기 시작했는데, 이 글을 정리하면서 당분간 자바스크립트를 더 깊게 공부하는 것에 집중할 것 같다.

그리고 또 한 번 내가 이해한다는 것에 대한 의심을 멈추면 안 되는 것을 상기한다. 지식의 깊이는 무한하다는 것을 잊지 말고, 끊임없이 내 지식의 타당성을 찾으려는 자세를 다시 한번 마음에 새긴다. 난 역시 모르는 게 너무 많다.

## Reference
- [이벤트 루프를 시각적으로 보여주는 사이트](http://latentflip.com/loupe/)
- [이벤트 루프에 대한 좋은 영상](https://www.youtube.com/watch?v=8aGhZQkoFbQ&t=70s)
- [자바스크립트는 어떻게 동작하는가?](https://engineering.huiseoul.com/%EC%9E%90%EB%B0%94%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%9E%91%EB%8F%99%ED%95%98%EB%8A%94%EA%B0%80-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EB%A3%A8%ED%94%84%EC%99%80-%EB%B9%84%EB%8F%99%EA%B8%B0-%ED%94%84%EB%A1%9C%EA%B7%B8%EB%9E%98%EB%B0%8D%EC%9D%98-%EB%B6%80%EC%83%81-async-await%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%BD%94%EB%94%A9-%ED%8C%81-%EB%8B%A4%EC%84%AF-%EA%B0%80%EC%A7%80-df65ffb4e7e)
- [tutorialslink](https://tutorialslink.com/Tutorials/Node-Js-Recipes-for-Beginners/24)