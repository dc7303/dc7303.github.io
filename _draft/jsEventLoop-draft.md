--
layout: post
title: "[JS] 자바스크립트 동작 원리와 이벤트루프"
date: 2019-10-26 12:00:00
category:
- javascript
tag:
- javascript
comments: true
---

자바스크립트는 '단일 스레드'기반의 언어다. 이말은 동시에 하나의 작업만을 처리할 수 있다는 말이다.  
하지만 실제로 자바스크립트를 사용하는 환경을 보면 동시성(Concurrency)을 가지고 있고 성능 또한 우수하다. 월마트가 노드JS 서버로 블랙프라이데이 온라인 트래픽의 53%를 처리할 때 노드 서버의 CPU 이용도가 약 1%였다는 것, 페이팔이 자바에서 노드JS로 교체 후 평균 응답시간이 35%가 단축된 것과 같은 사례들이 우수한 성능을 보여주고 있다는 증거다.
어떻게 단일 스레드 기반의 언어가 이런 성능을 낼 수 있었는 지 정리해보았다.

## 정리하게 된 동기
대용량 트래픽을 처리하기 위해 큰 기업들이 어떻게 이를 해결했는지 사례들을 찾아보고 있었다. 근데 눈에 띄는 사례 중 페이팔이 자바에서 노드JS로 교체 후 평균 응답시간이 35%나 단축되었 다는 것을 알게 되었다. 평소 자바스크립트를 좋아하는 필자에게는 재밌는 사례였다.

하지만 의문점이 있었다. 이벤트 루프 기반의 비동기성을 지원하지만, 싱글 스레드인 자바스크립트가 노드 서버에서 어떻게 높은 동시성을 가질 수 있는 지 깊게 알고 있지는 못했다.

그래서 자바스크립트 동작 원리를 다시 검색해보았고, 이를 잊지 않기 위해 최대한 핵심만을 정리를 해본다.



## 런타임(Runtime)
자바스크립트 엔진은 메모리 힙(Heap)과 단일 호출 스택(Call Stack)을 가지고 있다. 그리고 이 자바스크립트 엔진을 구동하는 환경(Node.js, 브라우저)이 큐(Queue)와 이벤트 루프(Event Loop)를 통해 비동기와 동시성을 담당한다.

### 힙(Heap)
객체들이 힙 안에 할당된다. 힙은 구조화되지 않은 넓은 메모리 영역을 지칭한다.

### 단일 호출 스택(Call Stack)
자바스크립트 엔진은 단일 호출 스택(Call Stack)을 가지고 있다. 하나의 호출 스택만을 가지고 있기 때문에 한번에 단 하나의 함수만 처리할 수 있다.  
이렇게 하나의 함수가 처리될 때 다른 함수가 끼어들 수 없는 것을 *Run to completion*이라고 한다.

### 큐(Queue)
이벤트 큐, 태스크 큐라고도 불리는 자바스크립트에서 큐는 자바스크립트 엔진 자체에서 존재하는 것이 아니다. 큐는 자바스크립트 엔진을 실행하는 환경에서 존재한다.  
큐의 역할은 실행될 콜백 함수들을 대기시키는 역할을 한다.

### 이벤트 루프(Event Loop)
이벤트 루프 또한 자바스크립트 엔진을 실행하는 환경에서 존재한다. 이벤트 루프는 스택이 비워질 때마다 큐에서 콜백 함수를 꺼내와서 실행하는 역할을 한다. 이때 콜백 함수는 호출 스택에 추가된다.

